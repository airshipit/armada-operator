# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- project:
    check:
      jobs:
        - armada-operator-docker-build-gate-ubuntu_jammy
        - armada-operator-airskiff-deployment-jammy

    gate:
      jobs:
        - armada-operator-docker-build-gate-ubuntu_jammy

    post:
      jobs:
        - armada-operator-docker-publish-ubuntu_jammy


- nodeset:
    name: armada-operator-single-node-jammy
    nodes:
      - name: primary
        label: ubuntu-jammy

- job:
    name: armada-operator-base
    abstract: true
    roles:
      - zuul: airship/kubernetes-entrypoint
      - zuul: openstack/openstack-helm
      - zuul: zuul/zuul-jobs
    required-projects:
      - name: openstack/openstack-helm
      - name: openstack/openstack-helm-plugin
      - name: airship/treasuremap
        override-checkout: v1.9
    irrelevant-files: &irrelevant-files
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^releasenotes/.*$
      - ^setup.cfg$
      - ^deckhand/tests/unit/.*$
    timeout: 10800
    pre-run:
      - tools/gate/playbooks/checkout-treasuremap-ref.yaml
      - tools/gate/playbooks/prepare-hosts.yaml
      - tools/gate/playbooks/mount-volumes.yaml
      - tools/gate/playbooks/deploy-env.yaml
    run:
      - tools/gate/playbooks/airship-run-scripts.yaml
    post-run:
      - tools/gate/playbooks/osh-infra-collect-logs.yaml
    vars:
      treasuremap_ref: v1.9
      overlay_network_setup: true
      extra_volume:
        size: 80G
        type: Linux
        mount_point: /opt/ext_vol
      docker:
        root_path: "/opt/ext_vol/docker"
      containerd:
        root_path: "/opt/ext_vol/containerd"
      kubeadm:
        pod_network_cidr: "10.244.0.0/16"
        service_cidr: "10.96.0.0/16"
      osh_plugin_repo: "{{ zuul.project.src_dir }}/../../openstack/openstack-helm-plugin"
      loopback_setup: true
      loopback_device: /dev/loop100
      loopback_image: "/opt/ext_vol/openstack-helm/ceph-loop.img"
      ceph_osd_data_device: /dev/loop100
      kube_version_repo: "v1.32"
      kube_version: "1.32.5-1.1"
      calico_setup: true
      calico_version: "v3.30.1"
      cilium_setup: false
      cilium_version: "1.17.4"
      flannel_setup: false
      flannel_version: v0.26.7
      metallb_setup: true
      metallb_version: "0.14.9"
      coredns_resolver_setup: false
      ingress_setup: true
      helm_version: "v3.18.1"
      crictl_version: "v1.33.0"
      run_helm_tests: "no"
      openstack_provider_gateway_setup: true
      zuul_osh_relative_path: ../../openstack/openstack-helm
      zuul_treasuremap_relative_path: ../../airship/treasuremap
      gate_scripts_relative_path: ../../openstack/openstack-helm

- job:
    name: armada-operator-airskiff-deployment-jammy
    nodeset: treasuremap-airskiff-1node-ubuntu_jammy
    description: |
      Deploy Memcached using Airskiff and submitted Armada-operator changes.
    parent: armada-operator-base
    vars:
      site: airskiff
      HELM_ARTIFACT_URL: https://get.helm.sh/helm-v3.18.4-linux-amd64.tar.gz
      HTK_COMMIT: 80041dfbb5c22aa67dcd8dfa3332a943aa0d366c
      OSH_COMMIT: 80041dfbb5c22aa67dcd8dfa3332a943aa0d366c
      CLONE_ARMADA_OPERATOR: false
      DISTRO: ubuntu_jammy
      DOCKER_REGISTRY: localhost:5000
      MAKE_ARMADA_OPERATOR_IMAGES: true
      USE_ARMADA_GO: true
      gate_scripts_relative_path: ../../airship/treasuremap
      gate_scripts:
        - ./tools/deployment/airskiff/developer/000-prepare-k8s.sh
        - ./tools/deployment/airskiff/developer/009-setup-apparmor.sh
        - ./tools/deployment/airskiff/developer/000-clone-dependencies.sh
        - ./tools/deployment/airskiff/developer/020-setup-client.sh
        - ./tools/deployment/airskiff/developer/015-make-all-charts.sh
        - ./tools/deployment/airskiff/developer/017-make-all-images.sh
        - ./tools/deployment/airskiff/developer/025-start-artifactory.sh
        - ./tools/deployment/airskiff/developer/026-reduce-site.sh
        - ./tools/deployment/airskiff/developer/027-enable-armada-operator.sh
        # pause
        # - ./tools/deployment/airskiff/common/sleep.sh
        - ./tools/deployment/airskiff/developer/030-armada-bootstrap.sh
        - ./tools/deployment/airskiff/developer/100-deploy-osh.sh
        - ./tools/deployment/airskiff/common/os-env.sh
        - ./tools/gate/wait-for-shipyard.sh
        - ./tools/deployment/airskiff/common/get-airflow-worker-logs.sh
    irrelevant-files: *irrelevant-files

- job:
    name: armada-operator-docker-build-gate-ubuntu_jammy
    timeout: 3600
    run: tools/gate/playbooks/docker-image-build.yaml
    nodeset: armada-operator-single-node-jammy
    vars:
      publish: false
      distro: ubuntu_jammy
      tags:
        dynamic:
          patch_set: true


- job:
    name: armada-operator-docker-publish-ubuntu_jammy
    timeout: 3600
    run: tools/gate/playbooks/docker-image-build.yaml
    nodeset: armada-operator-single-node-jammy
    secrets:
      - airship_armada_operator_quay_creds
    vars:
      publish: true
      distro: ubuntu_jammy
      tags:
        dynamic:
          branch: true
          commit: true
        static:
          - latest


- secret:
    name: airship_armada_operator_quay_creds
    data:
      username: !encrypted/pkcs1-oaep
        - DjQA+Mkrg0oNfTcPFBCOwx0K+B7LsV9ceV7MK9C83sZDKUC5aKfhdn/myvKQKunIth4B8
          y++q+ano+rk3fteyT5hAT73e59koN0EkHrMknqdm8C0AMXoGJ2ktZFwho0ehzj8WX43hW
          67cWRYUHImOxuUn9oaMT11ZrDCBbAz1gKLRGPgtiYaEnKjaksiAcaBY1xIIjvr+DFbBZ3
          CmZ39EKRwhJxfGBA7nKbC4fFTQpR9GQD6SBR5kz8J6nIzeywJ4KQQEoICb9kwa0y4us0D
          efxej72cEI31FXGeV9Hm6YpaKSBL/Ko67rrBU2P8+kdqtI5mTKyj97yMwEMqPn6E2RkQZ
          44l9OAOSJIYtHQyvdCfpoYhzojZRabpcKkgB1Lq///ysmRdDWA3CBTurIyR8zjJdGreaY
          DYiWFen50tlAgRwewWgWEIqPnmEKYCGKLF5BAK49NQWkcr/2d+TQLcyE7IYWJtp1VEHnb
          8t8gzvhwWcR0AKmxOMGO/TUuBw70nCl5FUl/lxBFVvlQS0eGM8ZcDvs3survIgjmHsyyI
          6LGuB6Yh+Qbw+YmBxSsp75mm9D+v0mFtdxCgs9JMTPFI3d40CGhDbAXfCYHqTrh71pSCq
          a+ZWtixKOqhmIY6T9QCyFvBPB2ozQbmfgIlrRcs5pcNzO/xQfGf8JDiIceG7nE=
      password: !encrypted/pkcs1-oaep
        - c3cKJlMVv6mXnkCPPVyfJ9Vra140TOZKIK041eaajHnqoxR+R2sI50PrvF3r0rqnCJ4hs
          955XM9Idk5Y6urkkg5XAPDXLU7scBwN/WxO6KWadwtoxSFgn3sF/bctE55m18PZakUo3u
          oB05pBRlS0NITf6PCvwi0CphJbJEayVsPuNGP2EqP5WJ8xOrRu48SiuOlF0UuTA05oCta
          oYMG691bTt8EdDawaVpqtDcOcGEEqjXfizCoTiZhSYbtU8u86QXysdhKTFkPZiVd5kKiH
          q3zKLH3DEjK2XdSv4vouarmgKFymJ1+1hfUdfR2zNiJDM7a1YjEkOKlC+MaTBbjaoL7TF
          DfYgBkef10U+pp8VpM+zaU8/nJgeAn1rJzEm6IbYqW8Cd6N7IC1qLPU8GG1d0QtrYy7FP
          xr/5aAtiGFQ9dyUuwqBgNGngu5RXKJdnXD0yaUQ2Ptju5fwUo/vnQId/K+L8KIOjjRd9h
          SYsOer9caZOZ8Sin7udDzH/L/yFQQeu/HCZqWNtMJR49a2TvI31v75TtoY2Z2JhkEIGs7
          PryaAxEZywk1xP701FLFsdIWPbpvu+TElNnbEc+dI6HXtdpV6hArHI1LY0qplLtNV7c/g
          GRXIKFyn7yVMpdRMt9i+IncN2m/xskSIn4IOgcLbTD4giFDE2ZBdpEareD4kEA=
